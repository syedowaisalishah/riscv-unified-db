---
# yaml-language-server: $schema=../../../schemas/inst_schema.json

$schema: "inst_schema.json#"
kind: instruction
name: amocas.w
long_name: No synopsis available.
description: |
  No description available.
definedBy: Zacas
assembly: xd, xs1, xs2, aq, rl
encoding:
  match: 00101------------010-----0101111
  variables:
    - name: aq
      location: 26-26
    - name: rl
      location: 25-25
    - name: rs2
      location: 24-20
    - name: rs1
      location: 19-15
    - name: rd
      location: 11-7
access:
  s: always
  u: always
  vs: always
  vu: always
data_independent_timing: false
operation(): |
  // AMOCAS.W - Atomic Compare-and-Swap Word (32-bit operation)
  try {
    let vaddr = X(rs1);
    let paddr = translateAddr(vaddr, ReadWrite(Data, Data));
    let compare_val = (rd == x0) ? 0 : X(rd)[31:0];
    let swap_val = (rs2 == x0) ? 0 : X(rs2)[31:0];

    let result = builtin_atomic_cas(
      width: 32,
      paddr: paddr,
      compare: compare_val,
      swap: swap_val,
      aq: aq,
      rl: rl
    );

    if (rd != x0) {
      X(rd) = (XLEN == 32) ? result : SignExtend(result, 32);
    }
  } catch (Exception e) {
    raise e;
  }
